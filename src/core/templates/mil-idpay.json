{
	"$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
	"contentVersion": "${content_version}",
	"parameters": {},
	"variables": {},
	"resources": [
		{
			"type": "Microsoft.App/containerApps",
			"apiVersion": "2022-06-01-preview",
			"name": "${name}",
			"location": "${location}",
			"properties": {
				"configuration": {
					"ingress": {
						"external": true,
						"targetPort": 8080,
						"transport": "Http"
					},
					"secrets": [
						{
							"name": "mongo-connection-string-1",
							"value": "${mongo_connection_string_1}"
						},
						{
							"name": "mongo-connection-string-2",
							"value": "${mongo_connection_string_2}"
						},
						{
							"name": "idpay-subscription-key",
							"value": "${idpay_subscription_key}"
						},
						{
                            "name": "azure-tenant-id",
                            "value": "${azure_tenant_id}"
                        },
                        {
                            "name": "azure-client-id",
                            "value": "${azure_client_id}"
                        },
                        {
                            "name": "azure-client-secret",
                            "value": "${azure_client_secret}"
                        }
					]
				},
				"managedEnvironmentId": "${managed_environment_id}",
				"template": {
					"containers": [
						{
							"env": [
								{
									"name": "TZ",
									"value": "Europe/Rome"
								},
								{
									"name": "mongo.connection-string-1",
									"secretRef": "mongo-connection-string-1"
								},
								{
									"name": "mongo.connection-string-2",
									"secretRef": "mongo-connection-string-2"
								},
								{
									"name": "idpay-rest-api.subscription-key",
									"secretRef": "idpay-subscription-key"
								},
								{
									"name": "quarkus-log-level",
									"value": "${quarkus_log_level}"
								},
								{
									"name": "app-log-level",
									"value": "${app_log_level}"
								},
								{
									"name": "jwt-publickey-location",
									"value": "${jwt_publickey_location}"
								},
								{
									"name": "transaction.max-retry",
									"value": "${transaction_max_retry}"
								},
								{
									"name": "transaction.retry-after",
									"value": "${transaction_retry_after}"
								},
								{
									"name": "transaction.location.base-url",
									"value": "${transaction_location_base_url}"
								},
								{
									"name": "idpay-rest-api.url",
									"value": "${idpay_rest_api_url}"
								},
								{
									"name": "mongo.connect-timeout",
									"value": "${mongo_connect_timeout}"
								},
								{
									"name": "mongo.read-timeout",
									"value": "${mongo_read_timeout}"
								},
								{
									"name": "mongo.server-selection-timeout",
									"value": "${mongo_server_selection_timeout}"
								},
                                {
                                    "name": "azuread_tenant_id",
                                    "secretRef": "azure-tenant-id"
                                },
                                {
                                    "name": "azuread_client_id",
                                    "secretRef": "azure-client-id"
                                },
                                {
                                    "name": "azuread_client_secret",
                                    "secretRef": "azure-client-secret"
                                },
                                {
                                    "name": "ipzs-rest-api.url",
                                    "value": "${ipzs_rest_api_url}"
                                },
                                {
                                    "name": "azuread-rest-api.url",
                                    "value": "${azuread_rest_api_url}"
                                },
                                {
                                    "name": "azurekv-rest-api.url",
                                    "value": "${azurekv_rest_api_url}"
                                },
                                {
                                    "name": "idpay.keysize",
                                    "value": "${keysize}"
                                },
                                {
                                    "name": "idpay.cryptoperiod",
                                    "value": "${cryptoperiod}"
                                }
							],
							"image": "${image}",
							"name": "mil-idpay",
							"resources": {
								"cpu": ${cpu},
								"ephemeralStorage": "${ephemeral_storage}",
								"memory": "${memory}"
							}
						}
					],
					"scale": {
						"maxReplicas": ${max_replicas},
						"minReplicas": ${min_replicas}
					}
				}
			}
		}
	],
	"outputs": {
		"ingress_fqdn": {
			"type": "String",
			"value": "[reference(resourceId('Microsoft.App/containerApps','${name}')).configuration.ingress.fqdn]"
		}
	}
}