# ---------- RESOURCE GROUP ---------- RESOURCE GROUP ---------- RESOURCE GROUP --------------------

# Login
az login

# Resource Group
az group create \
  --name mil-d-weu-rg \
  --location westeurope \
  --subscription DEV-mil

# ---------- NETWORK ---------- NETWORK ---------- NETWORK ---------- NETWORK ---------- NETWORK ---

# Virtual Network + Front-end Subnet
az network vnet create \
  --name mil-d-weu-vnet \
  --resource-group mil-d-weu-rg \
  --location westeurope \
  --address-prefix 10.0.0.0/16 \
  --subnet-name mil-d-weu-frontend-snet \
  --subnet-prefix 10.0.1.0/24

# Back-end Subnet
az network vnet subnet create \
  --name mil-d-weu-backend-snet \
  --resource-group mil-d-weu-rg \
  --vnet-name mil-d-weu-vnet \
  --address-prefix 10.0.2.0/23

# Data Subnet
az network vnet subnet create \
  --name mil-d-weu-data-snet \
  --resource-group mil-d-weu-rg \
  --vnet-name mil-d-weu-vnet \
  --address-prefix 10.0.4.0/24

# ---------- COSMOS ---------- COSMOS ---------- COSMOS ---------- COSMOS ---------- COSMOS --------

# Cosmos Account for MondoDB API.
az cosmosdb create \
  --name mil-d-weu-cosmos \
  --resource-group mil-d-weu-rg \
  --kind MongoDB \
  --server-version 4.2 \
  --default-consistency-level Eventual \
  --locations regionName=westeurope failoverPriority=0 isZoneRedundant=False \
  --capabilities EnableServerless

# MongoDB API Database.
az cosmosdb mongodb database create \
  --name mil \
  --account-name mil-d-weu-cosmos \
  --resource-group mil-d-weu-rg

# MongoDB API Collection.
az cosmosdb mongodb collection create \
  --name services \
  --database-name mil \
  --account-name mil-d-weu-cosmos \
  --resource-group mil-d-weu-rg \
  --idx "[{\"key\": {\"keys\": [\"channel\"]}, \"options\": {\"unique\": \"true\"}}]"

# ---------- CONTAINER APPS ---------- CONTAINER APP ---------- CONTAINER APP ----------------------

az extension add --name containerapp --upgrade
az provider register --namespace Microsoft.App
az provider register --namespace Microsoft.OperationalInsights

# Log Analytics Workspace.
az monitor log-analytics workspace create \
  --workspace-name mil-d-weu-log \
  --resource-group mil-d-weu-rg

# Container Apps Environment.
az containerapp env create \
  --name mil-d-weu-cae \
  --resource-group mil-d-weu-rg \
  --location westeurope \
  --infrastructure-subnet-resource-id /subscriptions/000df80e-d061-4064-998e-d4e32146d17b/resourceGroups/mil-d-weu-rg/providers/Microsoft.Network/virtualNetworks/mil-d-weu-vnet/subnets/mil-d-weu-backend-snet \
  --logs-workspace-id 1f265de9-759f-4f7a-ac06-5857ad31b537

# Container App.
az containerapp create \
  --name mil-d-weu-init-ca \
  --resource-group mil-d-weu-rg \
  --environment mil-d-weu-cae \
  --ingress external \
  --exposed-port 80 \
  --target-port 8080 \
  --transport http \
  --image "ghcr.io/pagopa/mil-functions:1.0.4" \
  --secrets "mongo-connection-string-1=mongodb://mil-d-weu-cosmos:fNEUhzLrw6Ir0a4uUgrvmMUeHzJ1Lv8HIO1fKXfD7cLPlVCqRHvclc0q8pgEOGcYtvEKnJOrClzkACDbN3m04g==@mil-d-weu-cosmos.mongo.cosmos.azure.com:10255/?ssl=true&replicaSet=globaldb&retrywrites=false&maxIdleTimeMS=120000&appName=@mil-d-weu-cosmos@" \
            "mongo-connection-string-2=mongodb://mil-d-weu-cosmos:hG9Lq9LUd7YrNpmlYTbZLgsW2jFZXCFAeX52py7IWEbQNcoOhZwmMEbSja9Xolxo94JK48fHTYC8ACDbIHfyOA==@mil-d-weu-cosmos.mongo.cosmos.azure.com:10255/?ssl=true&replicaSet=globaldb&retrywrites=false&maxIdleTimeMS=120000&appName=@mil-d-weu-cosmos@" \
  --env-vars "quarkus-log-level=ERROR" \
             "app-log-level=DEBUG" \
             "mongo-connect-timeout=5s" \
             "mongo-read-timeout=10s" \
             "mongo-server-selecion-timeout=5s" \
             "mongo-connection-string-1=secretref:mongo-connection-string-1" \
             "mongo-connection-string-2=secretref:mongo-connection-string-2"